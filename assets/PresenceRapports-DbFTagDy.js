import{m as k,p as H,c as d,a as n,b as t,x as q,j as y,O as C,J as U,F as V,h as F,t as o,o as u}from"./index-DNOX9g9Q.js";import{u as z}from"./usePresences-66VJQHx9.js";import{u as G}from"./useClasses-DkAspZBe.js";import{u as K}from"./useStudents-Bq4kq09d.js";import{u as Q}from"./useCours-CvA8_x3u.js";import{u as W}from"./usePeriodes-CobyAUWM.js";const X={class:"space-y-6"},Y={class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},Z={class:"flex flex-wrap gap-2"},ee=["disabled"],te={class:"grid gap-3 md:grid-cols-5"},se=["value"],le={key:0,class:"rounded-xl border border-slate-200 p-4 text-sm dark:border-slate-800"},ae={key:1,class:"rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-300"},oe={key:2,class:"rounded-xl border border-slate-200 p-4 text-sm text-slate-500 dark:border-slate-800 dark:text-slate-400"},re={key:3,class:"grid gap-3 sm:grid-cols-4"},de={class:"rounded-xl border border-slate-200 p-4 dark:border-slate-800"},ne={class:"mt-1 text-2xl font-semibold"},ue={class:"rounded-xl border border-slate-200 p-4 dark:border-slate-800"},ie={class:"mt-1 text-2xl font-semibold"},ce={class:"rounded-xl border border-slate-200 p-4 dark:border-slate-800"},pe={class:"mt-1 text-2xl font-semibold"},ve={class:"rounded-xl border border-slate-200 p-4 dark:border-slate-800"},be={class:"mt-1 text-2xl font-semibold"},xe={key:4,class:"overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-slate-800 dark:bg-slate-900"},me={class:"flex items-center justify-between border-b border-slate-100 px-4 py-3 text-sm dark:border-slate-800"},ge={class:"text-slate-600 dark:text-slate-300"},fe={class:"text-slate-500 dark:text-slate-400"},ke={class:"overflow-x-auto"},ye={class:"min-w-full text-left text-sm"},he={class:"bg-slate-50 text-slate-600 dark:bg-slate-800 dark:text-slate-300"},we={class:"px-4 py-3 font-medium sticky left-0 bg-slate-50 dark:bg-slate-800"},_e={class:"px-4 py-3 font-medium sticky left-0 bg-white dark:bg-slate-900"},Pe={class:"px-4 py-3"},Ae={class:"px-4 py-3"},Re={class:"px-4 py-3"},Se={class:"px-4 py-3"},je={class:"px-4 py-3"},Oe={__name:"PresenceRapports",setup(Ie){const h=z(),g=G(),w=K(),R=Q(),S=W(),c=k("classe"),O=new Date().toISOString().slice(0,10),B=new Date(Date.now()-29*864e5).toISOString().slice(0,10),_=k(B),P=k(O),p=k(""),v=k("");H(async()=>{await Promise.all([g.fetch(),w.fetch(),R.fetch(),S.fetch?.(),h.fetch()])});const E=d(()=>h.loading||g.loading||w.loading||R.loading||S.loading),$=d(()=>h.error?.message||g.error?.message||w.error?.message||R.error?.message||S.error?.message||null),L=d(()=>g.items||[]),D=d(()=>Object.fromEntries((w.items||[]).map(s=>[s.id,s]))),j=d(()=>Object.fromEntries((g.items||[]).map(s=>[s.id,s])));function M(s,e,l){return(!e||s>=e)&&(!l||s<=l)}const b=d(()=>(h.items||[]).filter(s=>!(!M(s.date,_.value,P.value)||p.value&&Number(s.classeId)!==Number(p.value)||v.value&&s.statut!==v.value)));function I(s,e,l){const x=new Map;s.forEach(a=>{const i=e(a),f=x.get(i)||{key:i,label:l(a),P:0,A:0,R:0,total:0};a.statut==="P"?f.P++:a.statut==="A"?f.A++:a.statut==="R"&&f.R++,f.total++,x.set(i,f)});const r=Array.from(x.values()).map(a=>({...a,tauxPresence:a.total?a.P/a.total:0}));return r.sort((a,i)=>i.tauxPresence-a.tauxPresence||i.total-a.total),r}const m=d(()=>c.value==="eleve"?I(b.value,s=>s.eleveId,s=>D.value[s.eleveId]?.nom||`Élève #${s.eleveId}`):c.value==="jour"?I(b.value,s=>s.date,s=>s.date):I(b.value,s=>s.classeId,s=>{const e=j.value[s.classeId];return e?e.libelle||e.label||e.code:`Classe #${s.classeId}`})),A=d(()=>{const s=b.value.filter(r=>r.statut==="P").length,e=b.value.filter(r=>r.statut==="A").length,l=b.value.filter(r=>r.statut==="R").length,x=b.value.length||1;return{P:s,A:e,R:l,tauxPresence:s/x}}),T=d(()=>c.value==="eleve"?"Élève":c.value==="jour"?"Jour":"Classe"),N=d(()=>{const s=p.value?j.value[p.value]?.libelle||j.value[p.value]?.code:"Toutes classes",e=v.value?v.value==="P"?"Présent":v.value==="A"?"Absent":"Retard":"Tous statuts";return`Synthèse ${T.value.toLowerCase()} — ${s} — ${_.value} → ${P.value} — ${e}`});function J(){const s=[T.value,"P","A","R","Total","TauxPresence"],e=m.value.map(a=>[a.label,a.P,a.A,a.R,a.total,`${(a.tauxPresence*100).toFixed(0)}%`]),l=[s,...e].map(a=>a.map(i=>`"${String(i).replace(/"/g,'""')}"`).join(",")).join(`
`),x=new Blob([l],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a");r.href=URL.createObjectURL(x),r.download=`rapports-presences-${c.value}.csv`,r.click(),URL.revokeObjectURL(r.href)}return(s,e)=>(u(),n("div",X,[t("div",Y,[e[6]||(e[6]=t("div",null,[t("h1",{class:"text-xl font-semibold"},"Rapports de présence"),t("p",{class:"text-sm text-slate-500 dark:text-slate-400"}," Taux de présence/absence/retard par classe, élève ou par jour. ")],-1)),t("div",Z,[t("button",{type:"button",class:"rounded-md border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900",onClick:e[0]||(e[0]=l=>s.window.print())}," Imprimer "),t("button",{type:"button",class:"rounded-md border border-violet-200 bg-violet-600 px-3 py-2 text-sm font-medium text-white hover:bg-violet-700 dark:border-violet-900",onClick:J,disabled:m.value.length===0}," Export CSV ",8,ee)])]),t("div",te,[y(t("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>c.value=l),class:"w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[...e[7]||(e[7]=[t("option",{value:"classe"},"Par classe",-1),t("option",{value:"eleve"},"Par élève",-1),t("option",{value:"jour"},"Par jour",-1)])],512),[[C,c.value]]),y(t("input",{"onUpdate:modelValue":e[2]||(e[2]=l=>_.value=l),type:"date",class:"w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},null,512),[[U,_.value]]),y(t("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>P.value=l),type:"date",class:"w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},null,512),[[U,P.value]]),y(t("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>p.value=l),class:"w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[e[8]||(e[8]=t("option",{value:""},"— Toutes classes —",-1)),(u(!0),n(V,null,F(L.value,l=>(u(),n("option",{key:l.id,value:l.id},o(l.libelle||l.label||l.code),9,se))),128))],512),[[C,p.value,void 0,{number:!0}]]),y(t("select",{"onUpdate:modelValue":e[5]||(e[5]=l=>v.value=l),class:"w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[...e[9]||(e[9]=[t("option",{value:""},"— Tous statuts —",-1),t("option",{value:"P"},"Présent",-1),t("option",{value:"A"},"Absent",-1),t("option",{value:"R"},"Retard",-1)])],512),[[C,v.value]])]),E.value?(u(),n("div",le,"Chargement…")):$.value?(u(),n("div",ae,o($.value),1)):m.value.length===0?(u(),n("div",oe," Aucun enregistrement pour ces filtres. ")):(u(),n("div",re,[t("div",de,[e[10]||(e[10]=t("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Présences",-1)),t("div",ne,o(A.value.P),1)]),t("div",ue,[e[11]||(e[11]=t("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Absences",-1)),t("div",ie,o(A.value.A),1)]),t("div",ce,[e[12]||(e[12]=t("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Retards",-1)),t("div",pe,o(A.value.R),1)]),t("div",ve,[e[13]||(e[13]=t("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Taux de présence",-1)),t("div",be,o((A.value.tauxPresence*100).toFixed(0))+"%",1)])])),m.value.length?(u(),n("div",xe,[t("div",me,[t("span",ge,o(N.value),1),t("span",fe,o(m.value.length)+" ligne(s)",1)]),t("div",ke,[t("table",ye,[t("thead",he,[t("tr",null,[t("th",we,o(T.value),1),e[14]||(e[14]=t("th",{class:"px-4 py-3 font-medium"},"Présent",-1)),e[15]||(e[15]=t("th",{class:"px-4 py-3 font-medium"},"Absent",-1)),e[16]||(e[16]=t("th",{class:"px-4 py-3 font-medium"},"Retard",-1)),e[17]||(e[17]=t("th",{class:"px-4 py-3 font-medium"},"Total",-1)),e[18]||(e[18]=t("th",{class:"px-4 py-3 font-medium"},"Taux présence",-1))])]),t("tbody",null,[(u(!0),n(V,null,F(m.value,l=>(u(),n("tr",{key:l.key,class:"border-t border-slate-100 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800/60"},[t("td",_e,o(l.label),1),t("td",Pe,o(l.P),1),t("td",Ae,o(l.A),1),t("td",Re,o(l.R),1),t("td",Se,o(l.total),1),t("td",je,o((l.tauxPresence*100).toFixed(0))+"%",1)]))),128))])])])])):q("",!0)]))}};export{Oe as default};
