import{K as y,L as p,M as v,N as o,O as l,P as u,Q as d,S as m,U as I,V as w,W as x}from"./index-Dl0Akbo7.js";const B=y("school",{state:()=>({students:[],classes:[],periodes:[],teachers:[],cours:[],evaluations:[],bulletinsMeta:[],interros:[],examens:[],devoirs:[],loading:!1,error:null,lastSync:null}),getters:{classById:e=>Object.fromEntries(e.classes.map(s=>[s.id,s])),periodById:e=>Object.fromEntries(e.periodes.map(s=>[s.id,s])),teacherById:e=>Object.fromEntries(e.teachers.map(s=>[s.id,s])),coursById:e=>Object.fromEntries(e.cours.map(s=>[s.id,s])),getClasse:e=>s=>e.classes.find(t=>t.id===Number(s))||null,getPeriode:e=>s=>e.periodes.find(t=>t.id===Number(s))||null,getPeriodeLabel:e=>s=>e.periodes.find(t=>t.id===Number(s))?.label??"",getStudent:e=>s=>e.students.find(t=>t.id===Number(s))||null,teacherName(){return e=>this.teacherById[e]?.nom||""},classeLabel(){return e=>this.classById[e]?.libelle||this.classById[e]?.label||""},coursMatiere(){return e=>this.coursById[e]?.matiere||""},coursClasseLabel(){return e=>{const s=this.coursById[e];return s?this.classeLabel(s.classeId):""}},coursPeriodeLabel(){return e=>{const s=this.coursById[e];return s?this.getPeriodeLabel(s.periodeId):""}},coursView(e){return e.cours.map(s=>({...s,classe:this.classeLabel(s.classeId),professeur:this.teacherName(s.teacherId),periode:this.getPeriodeLabel(s.periodeId)}))},interrosView(e){return e.interros.map(s=>{const t=this.coursById[s.coursId];return{...s,cours:t?.matiere||"",classe:t?this.classeLabel(t.classeId):"",bareme:s.bareme??10}})},examensView(e){return e.examens.map(s=>{const t=this.coursById[s.coursId];return{...s,cours:t?.matiere||"",classe:t?this.classeLabel(t.classeId):""}})},devoirsView(e){return e.devoirs.map(s=>{const t=this.coursById[s.coursId];return{...s,cours:t?.matiere||"",classe:t?this.classeLabel(t.classeId):"",periode:s.periodeId?this.getPeriodeLabel(s.periodeId):t?this.getPeriodeLabel(t.periodeId):""}})},classesView(e){return e.classes.map(s=>({id:s.id,code:s.code??"",libelle:s.libelle??s.label??"",niveau:s.niveau??"",filiere:s.filiere??"",effectif:Number(s.effectif??0),titulaire:s.titulaire??""}))},uniqueInterroCours(){return Array.from(new Set(this.interrosView.map(e=>e.cours).filter(Boolean))).sort()},uniqueInterroClasses(){return Array.from(new Set(this.interrosView.map(e=>e.classe).filter(Boolean))).sort()},uniqueExamCours(){return Array.from(new Set(this.examensView.map(e=>e.cours).filter(Boolean))).sort()},uniqueExamClasses(){return Array.from(new Set(this.examensView.map(e=>e.classe).filter(Boolean))).sort()},uniqueExamSessions(e){return Array.from(new Set(e.examens.map(s=>s.session).filter(Boolean))).sort()},uniqueDevoirCours(){return Array.from(new Set(this.devoirsView.map(e=>e.cours).filter(Boolean))).sort()},uniqueDevoirClasses(){return Array.from(new Set(this.devoirsView.map(e=>e.classe).filter(Boolean))).sort()},uniqueDevoirPeriodes(){return Array.from(new Set(this.devoirsView.map(e=>e.periode).filter(Boolean))).sort()},uniqueDevoirStatuts(e){return Array.from(new Set(e.devoirs.map(s=>s.statut).filter(Boolean))).sort()},uniqueCoursProfesseurs(){return Array.from(new Set(this.coursView.map(e=>e.professeur).filter(Boolean))).sort()},uniqueCoursClasses(){return Array.from(new Set(this.coursView.map(e=>e.classe).filter(Boolean))).sort()},uniqueCoursPeriodeLabels(){return Array.from(new Set(this.coursView.map(e=>e.periode).filter(Boolean))).sort()},uniqueClasseNiveaux(e){return Array.from(new Set(e.classes.map(s=>s.niveau).filter(Boolean))).sort()},uniqueClasseFilieres(e){return Array.from(new Set(e.classes.map(s=>s.filiere).filter(Boolean))).sort()},getEvaluations:e=>(s,t)=>e.evaluations.filter(r=>r.eleveId===Number(s)&&r.periodeId===Number(t)),getBulletinMeta:e=>(s,t)=>e.bulletinsMeta.find(r=>r.eleveId===Number(s)&&r.periodeId===Number(t))||{observationsGenerales:"",rank:null}},actions:{async init(e=!1){if(!(this.lastSync&&!e)){this.loading=!0,this.error=null;try{const[s,t,r,i,c,n,a,h,f,b]=await Promise.all([m.list(),I.list(),x.list(),w.list(),d.list(),v.list(),p.list(),u.list(),l.list(),o.list()]);Object.assign(this,{students:s,classes:t,periodes:r,teachers:i,cours:c,evaluations:n,bulletinsMeta:a,interros:h,examens:f,devoirs:b}),this.lastSync=new Date().toISOString()}catch(s){throw this.error=s.message||String(s),s}finally{this.loading=!1}}},async addEtudiant(e){const s=await m.create({matricule:"",photoUrl:"",...e});return this.students.push(s),s.id},async updateEtudiant(e){const s=await m.update(e.id,e),t=this.students.findIndex(r=>r.id===e.id);t>=0&&(this.students[t]=s)},async removeEtudiant(e){await m.remove(e),this.students=this.students.filter(s=>s.id!==e)},async addTeacher(e){const s=await w.create({statut:"Actif",...e});return this.teachers.push(s),s.id},async updateTeacher(e){const s=await w.update(e.id,e),t=this.teachers.findIndex(r=>r.id===e.id);t>=0&&(this.teachers[t]=s)},async removeTeacher(e){const s=this.cours.filter(t=>t.teacherId===e);await Promise.all(s.map(t=>d.update(t.id,{teacherId:null}))),await w.remove(e),this.cours=this.cours.map(t=>t.teacherId===e?{...t,teacherId:null}:t),this.teachers=this.teachers.filter(t=>t.id!==e)},async addClasse(e){const s={code:"",libelle:"",niveau:"",filiere:"",effectif:0,titulaire:"",...e};s.label=s.libelle||s.label||s.code;const t=await I.create(s);return this.classes.push(t),t.id},async updateClasse(e){const s={...e};s.label||(s.label=s.libelle||s.code);const t=await I.update(e.id,s),r=this.classes.findIndex(i=>i.id===e.id);r>=0&&(this.classes[r]=t)},async removeClasse(e){const s=this.students.filter(r=>r.classeId===e);await Promise.all(s.map(r=>m.update(r.id,{classeId:null}))),this.students=this.students.map(r=>r.classeId===e?{...r,classeId:null}:r);const t=this.cours.filter(r=>r.classeId===e).map(r=>r.id);await Promise.all([...this.interros.filter(r=>t.includes(r.coursId)).map(r=>u.remove(r.id)),...this.examens.filter(r=>t.includes(r.coursId)).map(r=>l.remove(r.id)),...this.devoirs.filter(r=>t.includes(r.coursId)).map(r=>o.remove(r.id)),...t.map(r=>d.remove(r))]),this.interros=this.interros.filter(r=>!t.includes(r.coursId)),this.examens=this.examens.filter(r=>!t.includes(r.coursId)),this.devoirs=this.devoirs.filter(r=>!t.includes(r.coursId)),this.cours=this.cours.filter(r=>r.classeId!==e),await I.remove(e),this.classes=this.classes.filter(r=>r.id!==e)},async addCours(e){const s=await d.create({code:"",matiere:"",intitule:"",classeId:null,teacherId:null,volume:0,periodeId:null,...e});return this.cours.push(s),s.id},async updateCours(e){const s=await d.update(e.id,e),t=this.cours.findIndex(r=>r.id===e.id);t>=0&&(this.cours[t]=s)},async removeCours(e){await Promise.all([...this.interros.filter(s=>s.coursId===e).map(s=>u.remove(s.id)),...this.examens.filter(s=>s.coursId===e).map(s=>l.remove(s.id)),...this.devoirs.filter(s=>s.coursId===e).map(s=>o.remove(s.id))]),await d.remove(e),this.interros=this.interros.filter(s=>s.coursId!==e),this.examens=this.examens.filter(s=>s.coursId!==e),this.devoirs=this.devoirs.filter(s=>s.coursId!==e),this.cours=this.cours.filter(s=>s.id!==e)},async addInterro(e){const s=await u.create({titre:"",type:"Programmée",date:"",bareme:10,...e});return this.interros.push(s),s.id},async updateInterro(e){const s=await u.update(e.id,e),t=this.interros.findIndex(r=>r.id===e.id);t>=0&&(this.interros[t]=s)},async removeInterro(e){await u.remove(e),this.interros=this.interros.filter(s=>s.id!==e)},async addExamen(e){const s=await l.create({titre:"",type:"Final",session:"Normale",date:"",bareme:20,...e});return this.examens.push(s),s.id},async updateExamen(e){const s=await l.update(e.id,e),t=this.examens.findIndex(r=>r.id===e.id);t>=0&&(this.examens[t]=s)},async removeExamen(e){await l.remove(e),this.examens=this.examens.filter(s=>s.id!==e)},async addDevoir(e){const s=await o.create({titre:"",dateRemise:"",bareme:20,statut:"Publié",periodeId:e.periodeId??null,...e});return this.devoirs.push(s),s.id},async updateDevoir(e){const s=await o.update(e.id,e),t=this.devoirs.findIndex(r=>r.id===e.id);t>=0&&(this.devoirs[t]=s)},async removeDevoir(e){await o.remove(e),this.devoirs=this.devoirs.filter(s=>s.id!==e)},async upsertEvaluation(e){const{eleveId:s,periodeId:t,matiere:r,type:i,coef:c}=e,n=await v.list({eleveId:s,periodeId:t,matiere:r,type:i,coef:c});if(n?.length){const a=n[0],h=await v.update(a.id,{...a,...e}),f=this.evaluations.findIndex(b=>b.id===a.id);return f>=0?this.evaluations[f]=h:this.evaluations.push(h),h.id}else{const a=await v.create(e);return this.evaluations.push(a),a.id}},async setBulletinMeta(e,s,t){const r=await p.list({eleveId:e,periodeId:s});if(r?.length){const i=r[0],c=await p.update(i.id,{...i,...t}),n=this.bulletinsMeta.findIndex(a=>a.id===i.id);n>=0&&(this.bulletinsMeta[n]=c)}else{const i=await p.create({eleveId:e,periodeId:s,...t});this.bulletinsMeta.push(i)}}}});export{B as u};
