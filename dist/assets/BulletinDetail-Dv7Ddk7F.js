import{m as b,l as S,p as T,w as J,c as m,V as U,a as r,b as e,t as o,k as g,F,h as H,j as Z,J as K,G as Q,o as n,x as W}from"./index-BVVU7ImF.js";import{u as X}from"./useStudents-D51OTvSI.js";import{u as Y}from"./useClasses-6cjNtIyF.js";import{u as $}from"./usePeriodes-DPgYpSBx.js";import{u as ee}from"./useEvaluations-2EkqKUXk.js";import{u as te}from"./useBulletinsMeta-84yHOEqD.js";import{_ as se}from"./_plugin-vue_export-helper-DlAUqK2U.js";const le={class:"space-y-6"},ae={class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between print:hidden"},oe={class:"text-xl font-semibold"},re={class:"text-sm text-slate-500 dark:text-slate-400"},ne={class:"only-print mb-3 hidden"},de={class:"text-center"},ie={class:"text-sm text-slate-600"},ue={class:"mt-1 text-sm"},ce={class:"grid gap-3 sm:grid-cols-3"},me={class:"rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900"},ve={class:"mt-1 text-2xl font-semibold"},be={class:"rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900"},pe={class:"mt-1 text-2xl font-semibold"},fe={class:"rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900"},xe={class:"mt-1 text-base font-medium"},ge={class:"overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-slate-800 dark:bg-slate-900"},he={key:0,class:"p-6"},ye={key:1,class:"p-6 text-sm text-red-600 dark:text-red-400"},ke={key:2,class:"p-6 text-sm text-slate-500 dark:text-slate-400"},_e={key:3,class:"overflow-x-auto"},we={class:"min-w-full text-left text-sm"},Ie={class:"px-4 py-3 font-medium"},Ne={class:"px-4 py-3"},Me={class:"space-y-1"},Be={class:"inline-flex items-center gap-1 rounded border border-slate-200 px-2 py-0.5 text-xs dark:border-slate-700"},Ce={class:"ml-2 text-xs text-slate-500 dark:text-slate-400"},Ee={key:0,class:"ml-2 italic opacity-75"},qe={class:"px-4 py-3 font-semibold"},De={class:"bg-slate-50 dark:bg-slate-800"},Ve={class:"px-4 py-3 font-semibold"},Le={class:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900 print:shadow-none"},Pe={class:"mt-3 flex items-center justify-end gap-2 print:hidden"},Fe=["disabled"],He={__name:"BulletinDetail",setup(ze){const d=S(),C=Q(),h=X(),y=Y(),k=$(),_=ee(),v=te(),i=b(d.query.eleveId?Number(d.query.eleveId):null),u=b(d.query.periodeId?Number(d.query.periodeId):null),c=b(null),p=b(!1),f=b(""),w=b(null);T(async()=>{try{await Promise.all([y.fetch(),k.fetch()])}catch(s){c.value=s?.message||"Erreur de chargement"}}),J([i,u],async([s,t])=>{if(!(!s||!t)){c.value=null;try{await h.getOne(s).catch(()=>{}),await _.fetch({eleveId:s,periodeId:t,_limit:1e4}),await v.fetch({eleveId:s,periodeId:t,_limit:1});const l=v.items?.find(a=>a.eleveId===s&&a.periodeId===t);f.value=l?.observationsGenerales||"",w.value=l?.rank??null}catch(l){c.value=l?.message||"Impossible de charger les données"}}},{immediate:!0});const E=m(()=>h.get?.(i.value)||null),q=m(()=>E.value?.nom||"—"),D=m(()=>{const s=y.byId?.[E.value?.classeId];return s?.libelle||s?.label||s?.code||""}),I=m(()=>(k.items||[]).find(s=>s.id===u.value)?.label||""),z=m(()=>y.loading||k.loading||h.loading||_.loading||v.loading);function G(s){const t=new Map;for(const l of s||[]){const a=l.matiere||"—";t.has(a)||t.set(a,[]),t.get(a).push({type:l.type,note:Number(l.note||0),coef:Number(l.coef||1),obs:l.obs||""})}return Array.from(t.entries()).map(([l,a])=>{const{sum:M,coef:L}=a.reduce((P,B)=>({sum:P.sum+B.note*B.coef,coef:P.coef+B.coef}),{sum:0,coef:0}),A=L>0?M/L:null;return{matiere:l,details:a,moyenne:A}}).sort((l,a)=>(l.matiere||"").localeCompare(a.matiere||""))}const N=m(()=>{if(!i.value||!u.value)return[];const s=(_.items||[]).filter(t=>t.eleveId===i.value&&t.periodeId===u.value);return G(s)}),V=m(()=>{const s=N.value.filter(l=>l.moyenne!=null);return s.length===0?null:s.reduce((l,a)=>l+a.moyenne,0)/s.length});async function O(){if(!(!i.value||!u.value))try{p.value=!0,c.value=null;const s=v.items?.find(l=>l.eleveId===i.value&&l.periodeId===u.value),t={eleveId:i.value,periodeId:u.value,observationsGenerales:f.value,rank:s?.rank??w.value??null};s?.id?await v.updateOne(s.id,t):await v.createOne(t)}catch(s){c.value=s?.message||"Erreur à l’enregistrement"}finally{p.value=!1}}function R(){history.length>1?C.back():C.replace("/bulletins")}function j(){window.print()}function x(s){return s==null||Number.isNaN(s)?"—":Number(s).toFixed(2)}return U(()=>{d.query.eleveId&&(i.value=Number(d.query.eleveId)),d.query.periodeId&&(u.value=Number(d.query.periodeId))}),(s,t)=>(n(),r("div",le,[e("div",ae,[e("div",null,[e("h1",oe,"Bulletin – "+o(q.value||"Élève"),1),e("p",re,o(D.value||"Classe —")+" • "+o(I.value||"Période —"),1)]),e("div",{class:"flex gap-2"},[e("button",{type:"button",class:"inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:hover:bg-slate-800 print:hidden",onClick:R},[...t[1]||(t[1]=[e("svg",{class:"h-4 w-4",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M11 19l-7-7 7-7 1.41 1.41L7.83 11H20v2H7.83l4.58 4.59L11 19z"})],-1),g(" Retour ",-1)])]),e("button",{type:"button",class:"inline-flex items-center gap-2 rounded-lg border border-violet-200 bg-violet-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-violet-700 dark:border-violet-900 print:hidden",onClick:j},[...t[2]||(t[2]=[e("svg",{class:"h-4 w-4",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1.5V8h4.5"}),e("path",{d:"M8 10h8v2H8zm0 4h8v2H8z"})],-1),g(" Exporter PDF ",-1)])])])]),e("div",ne,[e("div",de,[t[3]||(t[3]=e("div",{class:"text-lg font-semibold"},"Établissement",-1)),e("div",ie,"Bulletin scolaire – "+o(I.value||"—"),1),e("div",ue,o(q.value)+" • "+o(D.value),1)]),t[4]||(t[4]=e("hr",{class:"my-3 border-slate-300"},null,-1))]),e("div",ce,[e("div",me,[t[5]||(t[5]=e("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Moyenne générale",-1)),e("div",ve,o(x(V.value)),1)]),e("div",be,[t[6]||(t[6]=e("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Rang",-1)),e("div",pe,o(w.value??"—"),1)]),e("div",fe,[t[7]||(t[7]=e("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Période",-1)),e("div",xe,o(I.value||"—"),1)])]),e("div",ge,[z.value?(n(),r("div",he,[...t[8]||(t[8]=[e("div",{class:"h-4 w-1/3 animate-pulse rounded bg-slate-200 dark:bg-slate-800 mb-3"},null,-1),e("div",{class:"h-4 w-full animate-pulse rounded bg-slate-200 dark:bg-slate-800 mb-2"},null,-1),e("div",{class:"h-4 w-5/6 animate-pulse rounded bg-slate-200 dark:bg-slate-800"},null,-1)])])):c.value?(n(),r("div",ye,o(c.value),1)):N.value.length===0?(n(),r("div",ke," Aucune évaluation trouvée pour cette période. ")):(n(),r("div",_e,[e("table",we,[t[11]||(t[11]=e("thead",{class:"bg-slate-50 text-slate-600 dark:bg-slate-800 dark:text-slate-300"},[e("tr",null,[e("th",{class:"px-4 py-3 font-medium"},"Matière"),e("th",{class:"px-4 py-3 font-medium"},"Détails (type • note × coef)"),e("th",{class:"px-4 py-3 font-medium"},"Moy. matière")])],-1)),e("tbody",null,[(n(!0),r(F,null,H(N.value,l=>(n(),r("tr",{key:l.matiere,class:"border-t border-slate-100 dark:border-slate-800"},[e("td",Ie,o(l.matiere),1),e("td",Ne,[e("ul",Me,[(n(!0),r(F,null,H(l.details,(a,M)=>(n(),r("li",{key:M,class:"text-slate-700 dark:text-slate-200"},[e("span",Be,o(a.type||"—"),1),e("span",Ce,[g(o(x(a.note))+" × "+o(a.coef||1)+" ",1),a.obs?(n(),r("span",Ee,"("+o(a.obs)+")",1)):W("",!0)])]))),128))])]),e("td",qe,o(x(l.moyenne)),1)]))),128))]),e("tfoot",De,[e("tr",null,[t[9]||(t[9]=e("td",{class:"px-4 py-3 font-medium"},"Moyenne générale",-1)),t[10]||(t[10]=e("td",null,null,-1)),e("td",Ve,o(x(V.value)),1)])])])]))]),e("div",Le,[t[13]||(t[13]=e("label",{class:"mb-2 block text-sm font-medium"},"Observations générales",-1)),Z(e("textarea",{"onUpdate:modelValue":t[0]||(t[0]=l=>f.value=l),rows:"4",class:"w-full rounded-lg border border-slate-200 bg-white p-3 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100",placeholder:"Appréciations générales à l’attention de l’élève et des parents…"},null,512),[[K,f.value]]),e("div",Pe,[e("button",{class:"inline-flex items-center gap-2 rounded-lg border border-violet-200 bg-violet-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-violet-700 disabled:opacity-60 dark:border-violet-900",disabled:p.value,onClick:O},[t[12]||(t[12]=e("svg",{class:"h-4 w-4",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M5 12l4 4L19 6l-2-2-8 8-2-2-2 2z"})],-1)),g(" "+o(p.value?"Enregistrement…":"Enregistrer"),1)],8,Fe)])])]))}},Je=se(He,[["__scopeId","data-v-f10656da"]]);export{Je as default};
