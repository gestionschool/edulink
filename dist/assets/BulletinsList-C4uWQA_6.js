import{u as q}from"./useClasses-6cjNtIyF.js";import{u as H}from"./usePeriodes-DPgYpSBx.js";import{u as J}from"./useStudents-D51OTvSI.js";import{u as K}from"./useEvaluations-2EkqKUXk.js";import{u as Q}from"./useBulletinsMeta-84yHOEqD.js";import{a as u,o as c,b as e,F as _,h as L,t as p,r as W,w as R,j,J as P,d as $,e as S,k as y,f as B,g as A,m as N,p as X,c as w,H as Y}from"./index-BVVU7ImF.js";const Z={class:"grid gap-3 sm:grid-cols-2"},ee=["value"],te=["value"],se=["value"],le=["value"],oe={__name:"BulletinFilters",props:{classeId:String,periodeId:String,classesOptions:{type:Array,default:()=>[]},periodesOptions:{type:Array,default:()=>[]}},emits:["update:classeId","update:periodeId"],setup(n){return(f,v)=>(c(),u("div",Z,[e("select",{value:n.classeId,onChange:v[0]||(v[0]=o=>f.$emit("update:classeId",o.target.value)),class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[v[2]||(v[2]=e("option",{value:""},"Classe…",-1)),(c(!0),u(_,null,L(n.classesOptions,o=>(c(),u("option",{key:o.value,value:o.value},p(o.label),9,te))),128))],40,ee),e("select",{value:n.periodeId,onChange:v[1]||(v[1]=o=>f.$emit("update:periodeId",o.target.value)),class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[v[3]||(v[3]=e("option",{value:""},"Période…",-1)),(c(!0),u(_,null,L(n.periodesOptions,o=>(c(),u("option",{key:o.value,value:o.value},p(o.label),9,le))),128))],40,se)]))}},ae={class:"space-y-3 md:hidden"},de={class:"flex items-start justify-between gap-3"},re={class:"font-medium"},ne={class:"text-xs text-slate-500 dark:text-slate-400"},ie={class:"text-right"},ue={class:"text-lg font-semibold"},ce={class:"text-xs text-slate-500 dark:text-slate-400"},ve=["onUpdate:modelValue"],me={class:"flex justify-end gap-2"},pe={class:"flex items-center justify-end gap-2"},be=["disabled"],fe={class:"hidden md:block overflow-x-auto"},ge={class:"min-w-full text-left text-sm"},xe={class:"px-4 py-3"},he={class:"px-4 py-3"},ye={class:"px-4 py-3"},ke={class:"px-4 py-3 font-semibold"},Ie={class:"px-4 py-3"},we={class:"px-4 py-3"},_e=["onUpdate:modelValue"],$e={class:"px-4 py-3"},Ne={class:"flex justify-end gap-2"},Le={class:"flex items-center justify-end gap-2 border-t border-slate-100 px-4 py-3 text-sm dark:border-slate-800"},Ce=["disabled"],Oe={__name:"BulletinsTable",props:{rows:{type:Array,default:()=>[]},periodeLabel:{type:String,default:""},periodeId:{type:[String,Number],default:""},saving:{type:Boolean,default:!1}},emits:["save"],setup(n,{emit:f}){const v=n,o=W({});R(()=>v.rows,m=>{for(const l of m||[])o[l.eleveId]=l.observation||""},{immediate:!0,deep:!0});function k(m){return m==null||Number.isNaN(m)?"—":Number(m).toFixed(2)}return(m,l)=>(c(),u(_,null,[e("div",ae,[(c(!0),u(_,null,L(n.rows,s=>(c(),u("div",{key:s.eleveId,class:"rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900"},[e("div",de,[e("div",null,[e("div",re,p(s.nom),1),e("div",ne,p(s.classeLabel)+" • "+p(n.periodeLabel),1)]),e("div",ie,[e("div",ue,p(k(s.moyenne)),1),e("div",ce,"Rang "+p(s.rank??"—"),1)])]),j(e("textarea",{"onUpdate:modelValue":g=>o[s.eleveId]=g,placeholder:"Observations…",class:"mt-3 w-full rounded-lg border border-slate-200 bg-white p-2 text-sm dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100",rows:"2"},null,8,ve),[[P,o[s.eleveId]]]),e("div",me,[$(B(A),{to:`/bulletins/detail?eleveId=${s.eleveId}&periodeId=${n.periodeId}`,class:"rounded-lg border border-slate-200 px-2 py-1 text-xs hover:bg-slate-100 dark:border-slate-700 dark:hover:bg-slate-800"},{default:S(()=>[...l[2]||(l[2]=[y(" Détails ",-1)])]),_:1},8,["to"])])]))),128)),e("div",pe,[e("button",{class:"inline-flex items-center gap-2 rounded-lg border border-violet-200 bg-violet-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-violet-700 disabled:opacity-60 dark:border-violet-900",disabled:n.saving,onClick:l[0]||(l[0]=s=>m.$emit("save",o))},[l[3]||(l[3]=e("svg",{class:"h-4 w-4",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M5 12l4 4L19 6l-2-2-8 8-2-2-2 2z"})],-1)),y(" "+p(n.saving?"Enregistrement…":"Enregistrer"),1)],8,be)])]),e("div",fe,[e("table",ge,[l[5]||(l[5]=e("thead",{class:"bg-slate-50 text-slate-600 dark:bg-slate-800 dark:text-slate-300"},[e("tr",null,[e("th",{class:"px-4 py-3 font-medium"},"Élève"),e("th",{class:"px-4 py-3 font-medium"},"Classe"),e("th",{class:"px-4 py-3 font-medium"},"Période"),e("th",{class:"px-4 py-3 font-medium"},"Moyenne"),e("th",{class:"px-4 py-3 font-medium"},"Rang"),e("th",{class:"px-4 py-3 font-medium"},"Observations"),e("th",{class:"px-4 py-3 font-medium text-right"},"Actions")])],-1)),e("tbody",null,[(c(!0),u(_,null,L(n.rows,s=>(c(),u("tr",{key:s.eleveId,class:"border-t border-slate-100 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800/60"},[e("td",xe,p(s.nom),1),e("td",he,p(s.classeLabel),1),e("td",ye,p(n.periodeLabel),1),e("td",ke,p(k(s.moyenne)),1),e("td",Ie,p(s.rank??"—"),1),e("td",we,[j(e("textarea",{"onUpdate:modelValue":g=>o[s.eleveId]=g,class:"w-full min-w-[18rem] rounded-lg border border-slate-200 bg-white p-2 text-sm dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100",rows:"2",placeholder:"Observations…"},null,8,_e),[[P,o[s.eleveId]]])]),e("td",$e,[e("div",Ne,[$(B(A),{to:`/bulletins/detail?eleveId=${s.eleveId}&periodeId=${n.periodeId}`,class:"rounded-lg border border-slate-200 px-2 py-1 text-xs hover:bg-slate-100 dark:border-slate-700 dark:hover:bg-slate-800"},{default:S(()=>[...l[4]||(l[4]=[y(" Détails ",-1)])]),_:1},8,["to"])])])]))),128))])]),e("div",Le,[e("button",{class:"inline-flex items-center gap-2 rounded-lg border border-violet-200 bg-violet-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-violet-700 disabled:opacity-60 dark:border-violet-900",disabled:n.saving,onClick:l[1]||(l[1]=s=>m.$emit("save",o))},[l[6]||(l[6]=e("svg",{class:"h-4 w-4",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M5 12l4 4L19 6l-2-2-8 8-2-2-2 2z"})],-1)),y(" "+p(n.saving?"Enregistrement…":"Enregistrer"),1)],8,Ce)])])],64))}},Se={class:"space-y-6"},Be={class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},Me={class:"flex gap-2"},Ee={class:"overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-slate-800 dark:bg-slate-900"},je={key:0,class:"p-6"},Pe={key:1,class:"p-6 text-sm text-red-600 dark:text-red-400"},Ae={key:2,class:"p-6 text-sm text-slate-600 dark:text-slate-300"},Re={key:3,class:"p-6 text-sm text-slate-500 dark:text-slate-400"},Ve={key:4},qe={__name:"BulletinsList",setup(n){const f=q(),v=H(),o=J(),k=K(),m=Q(),l=N(""),s=N(""),g=N(null),C=N(!1);X(async()=>{await Promise.all([f.fetch(),v.fetch()])});const V=w(()=>(f.items||[]).map(d=>({value:String(d.id),label:d.libelle||d.label||d.code}))),z=w(()=>(v.items||[]).map(d=>({value:String(d.id),label:d.label}))),U=w(()=>(v.items||[]).find(d=>String(d.id)===String(s.value))?.label||""),F=w(()=>f.loading||v.loading||o.loading||k.loading||m.loading);R([l,s],async([d,t])=>{g.value=null,d&&(await o.fetch({classeId:Number(d)}),t&&await Promise.all([k.fetch({periodeId:Number(t),_limit:1e4}),m.fetch({periodeId:Number(t),_limit:1e4})]))},{immediate:!0});function D(d){const t={};for(const i of d||[]){const r=i.matiere||"—",h=Number(i.coef||1),I=Number(i.note||0);t[r]||(t[r]={sum:0,coef:0}),t[r].sum+=I*h,t[r].coef+=h}const x=Object.keys(t);if(x.length===0)return null;const b=x.map(i=>t[i].coef>0?t[i].sum/t[i].coef:0);return b.reduce((i,r)=>i+r,0)/b.length}const M=w(()=>{if(!l.value||!s.value)return[];const d=Number(s.value),t=[],x=Object.fromEntries((m.items||[]).filter(a=>Number(a.periodeId)===d).map(a=>[a.eleveId,a]));for(const a of o.items||[]){const O=(k.items||[]).filter(E=>E.eleveId===a.id&&Number(E.periodeId)===d),G=D(O);t.push({eleveId:a.id,nom:a.nom,classeLabel:f.byId?.[Number(l.value)]?.libelle||f.byId?.[Number(l.value)]?.label||"",moyenne:G,rank:x[a.id]?.rank??null,observation:x[a.id]?.observationsGenerales??""})}const b=[...t].sort((a,O)=>(O.moyenne??-1)-(a.moyenne??-1));let i=null,r=0,h=0;const I=new Map;for(const a of b){if(h++,a.moyenne==null){I.set(a.eleveId,null);continue}(i==null||a.moyenne<i)&&(r=h,i=a.moyenne),I.set(a.eleveId,r)}return t.forEach(a=>a.rank=I.get(a.eleveId)??a.rank),t});async function T(d){if(s.value)try{C.value=!0,g.value=null;const t=Number(s.value),x=await m.fetch({periodeId:t,_limit:1e4}),b=Object.fromEntries((x||[]).map(r=>[r.eleveId,r])),i=[];for(const r of M.value){const h={eleveId:r.eleveId,periodeId:t,observationsGenerales:d?.[r.eleveId]??r.observation??"",rank:r.rank??null};b[r.eleveId]?.id?i.push(m.updateOne(b[r.eleveId].id,h)):i.push(m.createOne(h))}await Promise.all(i)}catch(t){g.value=t?.message||"Erreur lors de l’enregistrement"}finally{C.value=!1}}return(d,t)=>{const x=Y("RouterLink");return c(),u("div",Se,[e("div",Be,[t[3]||(t[3]=e("div",null,[e("h1",{class:"text-xl font-semibold"},"Bulletins"),e("p",{class:"text-sm text-slate-500 dark:text-slate-400"}," Sélectionnez la classe et la période. Les moyennes et rangs sont calculés automatiquement. ")],-1)),e("div",Me,[$(x,{to:"/bulletin/recherche",class:"inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:hover:bg-slate-800"},{default:S(()=>[...t[2]||(t[2]=[e("svg",{class:"h-4 w-4",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"})],-1),y(" Recherche ",-1)])]),_:1})])]),$(oe,{classeId:l.value,"onUpdate:classeId":t[0]||(t[0]=b=>l.value=b),periodeId:s.value,"onUpdate:periodeId":t[1]||(t[1]=b=>s.value=b),"classes-options":V.value,"periodes-options":z.value},null,8,["classeId","periodeId","classes-options","periodes-options"]),e("div",Ee,[F.value?(c(),u("div",je,[...t[4]||(t[4]=[e("div",{class:"h-4 w-1/3 animate-pulse rounded bg-slate-200 dark:bg-slate-800 mb-3"},null,-1),e("div",{class:"h-4 w-full animate-pulse rounded bg-slate-200 dark:bg-slate-800 mb-2"},null,-1),e("div",{class:"h-4 w-5/6 animate-pulse rounded bg-slate-200 dark:bg-slate-800"},null,-1)])])):g.value?(c(),u("div",Pe,p(g.value),1)):!l.value||!s.value?(c(),u("div",Ae,[...t[5]||(t[5]=[y(" Choisissez une ",-1),e("b",null,"classe",-1),y(" et une ",-1),e("b",null,"période",-1),y(" pour afficher les bulletins. ",-1)])])):B(o).items.length===0?(c(),u("div",Re," Aucun élève dans cette classe. ")):(c(),u("div",Ve,[$(Oe,{rows:M.value,"periode-label":U.value,"periode-id":s.value,saving:C.value,onSave:T},null,8,["rows","periode-label","periode-id","saving"])]))])])}}};export{qe as default};
