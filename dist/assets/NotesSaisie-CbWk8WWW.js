import{a as r,o as d,b as e,F as k,h as C,t as v,x as D,k as y,u as K,m as g,p as Q,c as O,w as T,d as z,f as F}from"./index-BVVU7ImF.js";import{u as W}from"./useClasses-6cjNtIyF.js";import{u as X}from"./useCours-WlUt9X8U.js";import{u as Y}from"./usePeriodes-DPgYpSBx.js";import{u as Z}from"./useStudents-D51OTvSI.js";import{u as _}from"./useEvaluations-2EkqKUXk.js";const ee={class:"grid gap-3 sm:grid-cols-2 lg:grid-cols-5"},te=["value"],se=["value"],le=["value","disabled"],ae=["value"],oe=["value"],re=["value"],de=["value"],ne=["value"],ie=["value"],ue={__name:"NotesFilters",props:{classeId:String,coursId:String,periodeId:String,type:String,coef:[String,Number],classesOptions:{type:Array,default:()=>[]},coursOptions:{type:Array,default:()=>[]},periodesOptions:{type:Array,default:()=>[]},typesOptions:{type:Array,default:()=>["Devoir","Interro","Examen"]}},emits:["update:classeId","update:coursId","update:periodeId","update:type","update:coef"],setup(s){return(p,a)=>(d(),r("div",ee,[e("select",{value:s.classeId,onChange:a[0]||(a[0]=t=>p.$emit("update:classeId",t.target.value)),class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[a[5]||(a[5]=e("option",{value:""},"Choisir une classe…",-1)),(d(!0),r(k,null,C(s.classesOptions,t=>(d(),r("option",{key:t.value,value:t.value},v(t.label),9,se))),128))],40,te),e("select",{value:s.coursId,onChange:a[1]||(a[1]=t=>p.$emit("update:coursId",t.target.value)),disabled:!s.classeId,class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm disabled:opacity-60 focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[a[6]||(a[6]=e("option",{value:""},"Cours…",-1)),(d(!0),r(k,null,C(s.coursOptions,t=>(d(),r("option",{key:t.value,value:t.value},v(t.label),9,ae))),128))],40,le),e("select",{value:s.periodeId,onChange:a[2]||(a[2]=t=>p.$emit("update:periodeId",t.target.value)),class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[a[7]||(a[7]=e("option",{value:""},"Période…",-1)),(d(!0),r(k,null,C(s.periodesOptions,t=>(d(),r("option",{key:t.value,value:t.value},v(t.label),9,re))),128))],40,oe),e("select",{value:s.type,onChange:a[3]||(a[3]=t=>p.$emit("update:type",t.target.value)),class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[a[8]||(a[8]=e("option",{value:""},"Type…",-1)),(d(!0),r(k,null,C(s.typesOptions,t=>(d(),r("option",{key:t,value:t},v(t),9,ne))),128))],40,de),e("input",{value:s.coef,onInput:a[4]||(a[4]=t=>p.$emit("update:coef",t.target.value)),type:"number",min:"1",step:"1",placeholder:"Coef",class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},null,40,ie)]))}},ce={class:"block md:hidden divide-y divide-slate-100 dark:divide-slate-800"},ve={class:"font-medium"},me={class:"mt-2 flex items-center gap-3"},pe={class:"text-xs opacity-70"},be=["max","value","onInput"],fe={key:0,class:"mt-1 text-xs text-slate-500 dark:text-slate-400"},ge={class:"hidden md:block overflow-x-auto"},xe={class:"min-w-full text-left text-sm"},ye={class:"bg-slate-50 text-slate-600 dark:bg-slate-800 dark:text-slate-300"},ke={class:"px-4 py-3 font-medium w-36"},he={class:"px-4 py-3"},Ie={class:"px-4 py-3"},we=["max","value","onInput"],$e={class:"px-4 py-3 text-slate-500 dark:text-slate-400"},Ne={class:"flex items-center justify-between border-t border-slate-100 px-4 py-3 text-sm dark:border-slate-800"},Se={class:"text-slate-500 dark:text-slate-400"},Oe=["disabled"],Ce={__name:"NotesEntryTable",props:{students:{type:Array,default:()=>[]},bareme:{type:Number,default:20},modelValue:{type:Object,default:()=>({})},extras:{type:Object,default:()=>({})},saving:{type:Boolean,default:!1}},emits:["update:modelValue","save"],setup(s,{emit:p}){const a=s,t=p;function h(b,u){const n=u===""?"":Number(u),m={...a.modelValue,[b]:n};t("update:modelValue",m)}return(b,u)=>(d(),r(k,null,[e("div",ce,[(d(!0),r(k,null,C(s.students,n=>(d(),r("div",{key:n.id,class:"p-4"},[e("div",ve,v(n.nom),1),e("div",me,[e("label",pe,"Note / "+v(s.bareme),1),e("input",{type:"number",min:"0",max:s.bareme,step:"0.5",value:s.modelValue[n.id]??"",onInput:m=>h(n.id,m.target.value),class:"w-24 rounded-lg border border-slate-200 bg-white px-2 py-1 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},null,40,be)]),s.extras[n.id]?(d(),r("p",fe,v(s.extras[n.id]),1)):D("",!0)]))),128))]),e("div",ge,[e("table",xe,[e("thead",ye,[e("tr",null,[u[1]||(u[1]=e("th",{class:"px-4 py-3 font-medium"},"Élève",-1)),e("th",ke,"Note / "+v(s.bareme),1),u[2]||(u[2]=e("th",{class:"px-4 py-3 font-medium"},"Info",-1))])]),e("tbody",null,[(d(!0),r(k,null,C(s.students,n=>(d(),r("tr",{key:n.id,class:"border-t border-slate-100 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800/60"},[e("td",he,v(n.nom),1),e("td",Ie,[e("input",{type:"number",min:"0",max:s.bareme,step:"0.5",value:s.modelValue[n.id]??"",onInput:m=>h(n.id,m.target.value),class:"w-28 rounded-lg border border-slate-200 bg-white px-2 py-1 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},null,40,we)]),e("td",$e,v(s.extras[n.id]||"—"),1)]))),128))])])]),e("div",Ne,[e("span",Se,v(s.students.length)+" élèves ",1),e("button",{class:"inline-flex items-center gap-2 rounded-lg border border-violet-200 bg-violet-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-violet-700 disabled:opacity-60 dark:border-violet-900",disabled:s.saving,onClick:u[0]||(u[0]=n=>b.$emit("save"))},[u[3]||(u[3]=e("svg",{class:"h-4 w-4",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M5 12l4 4L19 6l-2-2-8 8-2-2-2 2z"})],-1)),y(" "+v(s.saving?"Enregistrement…":"Enregistrer"),1)],8,Oe)])],64))}},Ee={class:"space-y-6"},Ve={class:"overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-slate-800 dark:bg-slate-900"},Ae={key:0,class:"p-6"},Ue={key:1,class:"p-6 text-sm text-red-600 dark:text-red-400"},Be={key:2,class:"p-6 text-sm text-slate-600 dark:text-slate-300"},Pe={key:3,class:"p-6 text-sm text-slate-500 dark:text-slate-400"},je={key:4},Te={key:0,class:"text-sm text-green-600 dark:text-green-400"},qe={__name:"NotesSaisie",setup(s){const p=K(),a=W(),t=X(),h=Y(),b=Z(),u=_(),n=g(""),m=g(""),I=g(""),w=g("Devoir"),$=g(1),N=g({}),V=g(!1),B=g(!1),S=g(null);Q(async()=>{await Promise.all([a.fetch(),h.fetch(),t.fetch({_sort:"code"})])});const L=O(()=>(a.items||[]).map(o=>({value:String(o.id),label:o.libelle||o.label||o.code}))),M=O(()=>{const o=Number(n.value||0),l=p.role,i=p.user?.id;return(t.items||[]).filter(c=>o?c.classeId===o:!0).filter(c=>l==="PROFESSEUR"&&i?c.teacherId===i:!0).map(c=>({value:String(c.id),label:`${c.code} • ${c.intitule}`}))}),R=O(()=>(h.items||[]).map(o=>({value:String(o.id),label:o.label}))),q=O(()=>a.loading||t.loading||h.loading||b.loading||u.loading),A=O(()=>!!(n.value&&m.value&&I.value&&w.value&&Number($.value)>0)),G=O(()=>({}));T(n,async o=>{N.value={},o&&await b.fetch({classeId:Number(o)})}),T([m,I,w,$],async()=>{if(N.value={},!!A.value){S.value=null;try{const o=(t.items||[]).find(x=>String(x.id)===String(m.value)),l=o?.matiere||o?.intitule||"";if(!l)return;const i=await u.fetch({periodeId:Number(I.value),matiere:l,type:w.value,coef:Number($.value),_limit:1e3}),c={};i.forEach(x=>{x.eleveId!=null&&(c[x.eleveId]=x.note)}),N.value=c}catch(o){S.value=o?.message||"Erreur de chargement des notes"}}});async function H(){if(A.value){V.value=!0,S.value=null;try{const o=(t.items||[]).find(f=>String(f.id)===String(m.value)),l=o?.matiere||o?.intitule||"",i=Number(I.value),c=w.value,x=Number($.value),J=await u.fetch({periodeId:i,matiere:l,type:c,coef:x,_limit:1e3}),P=Object.fromEntries((J||[]).map(f=>[f.eleveId,f])),U=[];for(const f of b.items||[]){const E=N.value[f.id];if(E===""||E==null||isNaN(Number(E)))continue;const j={eleveId:f.id,periodeId:i,matiere:l,type:c,coef:x,note:Number(E),obs:""};P[f.id]?.id?U.push(u.updateOne(P[f.id].id,j)):U.push(u.createOne(j))}await Promise.all(U),B.value=!0}catch(o){S.value=o?.message||"Erreur lors de l’enregistrement"}finally{V.value=!1}}}return(o,l)=>(d(),r("div",Ee,[l[8]||(l[8]=e("div",{class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},[e("div",null,[e("h1",{class:"text-xl font-semibold"},"Saisie des notes"),e("p",{class:"text-sm text-slate-500 dark:text-slate-400"}," Choisissez la classe, le cours et la période puis saisissez les notes. ")])],-1)),z(ue,{classeId:n.value,"onUpdate:classeId":l[0]||(l[0]=i=>n.value=i),coursId:m.value,"onUpdate:coursId":l[1]||(l[1]=i=>m.value=i),periodeId:I.value,"onUpdate:periodeId":l[2]||(l[2]=i=>I.value=i),type:w.value,"onUpdate:type":l[3]||(l[3]=i=>w.value=i),coef:$.value,"onUpdate:coef":l[4]||(l[4]=i=>$.value=i),"classes-options":L.value,"cours-options":M.value,"periodes-options":R.value},null,8,["classeId","coursId","periodeId","type","coef","classes-options","cours-options","periodes-options"]),e("div",Ve,[q.value?(d(),r("div",Ae,[...l[6]||(l[6]=[e("div",{class:"h-4 w-1/3 animate-pulse rounded bg-slate-200 dark:bg-slate-800 mb-3"},null,-1),e("div",{class:"h-4 w-full animate-pulse rounded bg-slate-200 dark:bg-slate-800 mb-2"},null,-1),e("div",{class:"h-4 w-5/6 animate-pulse rounded bg-slate-200 dark:bg-slate-800"},null,-1)])])):S.value?(d(),r("div",Ue,v(S.value),1)):A.value?F(b).items.length===0?(d(),r("div",Pe," Aucun élève trouvé pour cette classe. ")):(d(),r("div",je,[z(Ce,{students:F(b).items,bareme:20,modelValue:N.value,"onUpdate:modelValue":l[5]||(l[5]=i=>N.value=i),extras:G.value,saving:V.value,onSave:H},null,8,["students","modelValue","extras","saving"])])):(d(),r("div",Be,[...l[7]||(l[7]=[y(" Sélectionnez ",-1),e("b",null,"classe",-1),y(", ",-1),e("b",null,"cours",-1),y(", ",-1),e("b",null,"période",-1),y(", ",-1),e("b",null,"type",-1),y(" et ",-1),e("b",null,"coef",-1),y(" pour commencer. ",-1)])]))]),B.value?(d(),r("p",Te,"Enregistré ✅")):D("",!0)]))}};export{qe as default};
