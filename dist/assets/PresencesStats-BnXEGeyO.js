import{m as p,p as D,w as E,c as d,a as r,b as e,j as x,J as R,O as S,F as h,h as _,t as a,o as n,S as M}from"./index-BVVU7ImF.js";import{u as O}from"./usePresences-CCaBaJjc.js";import{u as G}from"./useClasses-6cjNtIyF.js";import{u as $}from"./useStudents-D51OTvSI.js";import{u as q}from"./useCours-WlUt9X8U.js";const z={class:"space-y-6"},J={class:"grid gap-3 md:grid-cols-4"},L=["value"],H={class:"grid gap-3 sm:grid-cols-3"},K={class:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900"},Q={class:"mt-1 text-2xl font-semibold"},W={class:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900"},X={class:"mt-1 text-2xl font-semibold"},Y={class:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900"},Z={class:"mt-1 text-2xl font-semibold"},ee={class:"overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-slate-800 dark:bg-slate-900"},te={class:"overflow-x-auto"},se={class:"min-w-full text-left text-sm"},le={class:"bg-slate-50 text-slate-600 dark:bg-slate-800 dark:text-slate-300"},ae={class:"px-4 py-3 font-medium"},oe={class:"px-4 py-3 font-medium"},de={class:"px-4 py-3"},re={class:"px-4 py-3"},ne={class:"px-4 py-3"},ie={class:"px-4 py-3"},ue={class:"px-4 py-3"},ce={class:"flex items-center gap-2"},be={class:"h-2 w-40 rounded bg-slate-200 dark:bg-slate-800 overflow-hidden"},me={class:"text-xs text-slate-600 dark:text-slate-300"},pe={class:"border-t border-slate-100 px-4 py-3 text-sm text-slate-500 dark:border-slate-800 dark:text-slate-400"},xe={class:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900"},ve={class:"mt-3 grid gap-2 sm:grid-cols-2 lg:grid-cols-3"},fe={class:"font-medium"},ge={class:"mt-1 text-xs text-slate-500 dark:text-slate-400"},Pe={__name:"PresencesStats",setup(ke){const v=O(),f=G(),w=$(),I=q(),A=new Date().toISOString().slice(0,10),i=p(A),u=p(A),c=p(""),b=p("classe");D(async()=>{await Promise.all([f.fetch(),w.fetch(),I.fetch()]),await P()}),E([i,u,c],P);function P(){const l={...i.value?{date_gte:i.value}:{},...u.value?{date_lte:u.value}:{},...c.value?{classeId:Number(c.value)}:{},_limit:5e3};return v.fetch(l)}const B=d(()=>f.items||[]),T=d(()=>f.byId||{}),C=d(()=>w.byId||{}),g=d(()=>{const l={P:0,A:0,R:0};return(v.items||[]).forEach(t=>{l[t.statut]=(l[t.statut]||0)+1}),l}),V=d(()=>{const l={};return(v.items||[]).forEach(t=>{const s=b.value==="classe"?t.classeId??"NA":t.eleveId??"NA";l[s]||(l[s]={key:s,P:0,A:0,R:0,total:0});const m=l[s];m[t.statut]=(m[t.statut]||0)+1,m.total++}),Object.values(l)}),k=d(()=>V.value.map(l=>{let t="";if(b.value==="classe"){const o=T.value[l.key];t=o?o.libelle||o.label||o.code:`Classe #${l.key}`}else{const o=C.value[l.key];t=o?o.nom||o.name:`Élève #${l.key}`}const s=l.P||0,m=l.A||0,U=l.R||0,y=l.total||0,j=y?s/y*100:0;return{...l,label:t,P:s,A:m,R:U,total:y,rate:j}}).sort((l,t)=>t.total-l.total)),F=d(()=>[...k.value].sort((l,t)=>t.A-l.A||t.R-l.R).slice(0,6));function N(){window.print()}return(l,t)=>(n(),r("div",z,[e("div",{class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},[t[4]||(t[4]=e("div",null,[e("h1",{class:"text-xl font-semibold"},"Présences — Statistiques"),e("p",{class:"text-sm text-slate-500 dark:text-slate-400"},"Période agrégée par classe et élève")],-1)),e("div",{class:"flex flex-wrap gap-2"},[e("button",{class:"inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-medium shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900",onClick:N}," Imprimer ")])]),e("div",J,[x(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>i.value=s),type:"date",class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},null,512),[[R,i.value]]),x(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>u.value=s),type:"date",class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},null,512),[[R,u.value]]),x(e("select",{"onUpdate:modelValue":t[2]||(t[2]=s=>c.value=s),class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[t[5]||(t[5]=e("option",{value:""},"Toutes classes",-1)),(n(!0),r(h,null,_(B.value,s=>(n(),r("option",{key:s.id,value:s.id},a(s.libelle||s.label||s.code),9,L))),128))],512),[[S,c.value,void 0,{number:!0}]]),x(e("select",{"onUpdate:modelValue":t[3]||(t[3]=s=>b.value=s),class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-violet-500 focus:ring-1 focus:ring-violet-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[...t[6]||(t[6]=[e("option",{value:"classe"},"Grouper par classe",-1),e("option",{value:"eleve"},"Grouper par élève",-1)])],512),[[S,b.value]])]),e("div",H,[e("div",K,[t[7]||(t[7]=e("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Présents",-1)),e("div",Q,a(g.value.P),1)]),e("div",W,[t[8]||(t[8]=e("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Absents",-1)),e("div",X,a(g.value.A),1)]),e("div",Y,[t[9]||(t[9]=e("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Retards",-1)),e("div",Z,a(g.value.R),1)])]),e("div",ee,[e("div",te,[e("table",se,[e("thead",le,[e("tr",null,[e("th",ae,a(b.value==="classe"?"Classe":"Élève"),1),t[10]||(t[10]=e("th",{class:"px-4 py-3 font-medium"},"P",-1)),t[11]||(t[11]=e("th",{class:"px-4 py-3 font-medium"},"A",-1)),t[12]||(t[12]=e("th",{class:"px-4 py-3 font-medium"},"R",-1)),t[13]||(t[13]=e("th",{class:"px-4 py-3 font-medium"},"Total",-1)),t[14]||(t[14]=e("th",{class:"px-4 py-3 font-medium"},"Taux présence",-1))])]),e("tbody",null,[(n(!0),r(h,null,_(k.value,s=>(n(),r("tr",{key:s.key,class:"border-t border-slate-100 dark:border-slate-800"},[e("td",oe,a(s.label),1),e("td",de,a(s.P),1),e("td",re,a(s.A),1),e("td",ne,a(s.R),1),e("td",ie,a(s.total),1),e("td",ue,[e("div",ce,[e("div",be,[e("div",{class:"h-2 bg-emerald-500",style:M({width:s.rate+"%"})},null,4)]),e("span",me,a(s.rate.toFixed(0))+"%",1)])])]))),128))])]),e("div",pe,a(k.value.length)+" lignes ",1)])]),e("div",xe,[t[15]||(t[15]=e("h2",{class:"text-sm font-semibold"},"Top absences",-1)),e("div",ve,[(n(!0),r(h,null,_(F.value,s=>(n(),r("div",{key:s.key,class:"rounded-lg border border-slate-200 p-3 text-sm dark:border-slate-800"},[e("div",fe,a(s.label),1),e("div",ge," Absences: "+a(s.A)+" — Retards: "+a(s.R),1)]))),128))])])]))}};export{Pe as default};
