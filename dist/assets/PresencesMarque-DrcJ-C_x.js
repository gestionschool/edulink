import{u as L,m as k,p as z,w as J,c as m,a,b as s,j as $,J as G,O,F as g,h as C,x as H,t as n,f as K,o,n as f}from"./index-BVVU7ImF.js";import{u as Q}from"./useClasses-6cjNtIyF.js";import{u as W}from"./useCours-WlUt9X8U.js";import{u as X}from"./useStudents-D51OTvSI.js";import{u as Y}from"./usePresences-CCaBaJjc.js";const Z={class:"space-y-6"},ee={class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},te={class:"flex flex-wrap gap-2"},se=["disabled"],le=["disabled"],ae=["disabled"],oe=["disabled"],ne={key:0},ie={key:1},re={class:"grid gap-3 sm:grid-cols-3"},de=["value"],ue=["value"],ce={key:0,class:"panel-muted"},ve={key:1,class:"panel-muted"},be={key:2,class:"panel"},me={class:"panel-head"},pe={class:"text-slate-600 dark:text-slate-300"},_e={key:0,class:"text-slate-500 dark:text-slate-400"},fe={class:"md:hidden divide-y divide-slate-100 dark:divide-slate-800"},he={class:"min-w-0"},xe={class:"truncate text-sm font-medium"},ke={class:"text-xs text-slate-500 dark:text-slate-400"},ye={class:"shrink-0 flex gap-1"},ge=["onClick"],Ce=["onClick"],we=["onClick"],Ie={class:"hidden md:block overflow-x-auto"},Ne={class:"min-w-full text-left text-sm"},Se={class:"px-4 py-3"},Pe={class:"px-4 py-3 text-slate-500 dark:text-slate-400"},Ae={class:"px-4 py-3"},$e={class:"inline-flex rounded-md border border-slate-200 overflow-hidden dark:border-slate-700"},je=["onClick"],Ee=["onClick"],Re=["onClick"],Me={class:"sticky bottom-0 flex items-center justify-between gap-3 border-t border-slate-100 bg-white/90 px-4 py-3 backdrop-blur dark:border-slate-800 dark:bg-slate-900/80"},Oe={class:"text-xs text-slate-500 dark:text-slate-400"},Be=["disabled"],Le={__name:"PresencesMarque",setup(Ve){const j=L(),w=Q(),I=W(),E=X(),c=Y(),B=new Date().toISOString().slice(0,10),v=k(B),i=k(""),b=k(""),h=k(!1),r=k({});z(async()=>{await Promise.all([w.fetch(),I.fetch(),E.fetch()])}),J([v,i,b],async()=>{const l=Number(i.value),e=Number(b.value);if(!(!v.value||!l||!e))try{await c.fetch({date:v.value,classeId:l,coursId:e});const t={};(c.items||[]).forEach(d=>{t[d.eleveId]=d.statut}),r.value=t}catch(t){console.error("[presences] fetch error",t),r.value={}}});const V=m(()=>w.items||[]),T=m(()=>{const l=Number(i.value);return(I.items||[]).filter(e=>Number(e.classeId)===l)}),x=m(()=>{const l=Number(i.value);return(E.items||[]).filter(e=>Number(e.classeId)===l)}),q=m(()=>{const l=Number(i.value),e=w.byId?.[l];return e?e.libelle||e.label||e.code:""}),D=m(()=>{const l=Number(b.value),e=I.byId?.[l];return e?`${e.matiere} — ${e.intitule||e.code}`:""}),p=m(()=>!!v.value&&!!Number(i.value)&&!!Number(b.value)),F=m(()=>Object.keys(r.value).length);function N(l,e){return["h-8 w-8 inline-flex items-center justify-center rounded-md border text-xs",r.value[l]===e?"border-violet-300 bg-violet-600 text-white dark:border-violet-800":"border-slate-200 bg-white text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200"].join(" ")}function S(l,e){return["px-3 py-1 text-xs",r.value[l]===e?"bg-violet-600 text-white":"bg-white text-slate-700 hover:bg-slate-50 dark:bg-slate-900 dark:text-slate-200"].join(" ")}function _(l,e){r.value={...r.value,[l]:e}}function P(l){const e={};x.value.forEach(t=>{e[t.id]=l}),r.value=e}async function R(){if(p.value){h.value=!0;try{const l=Number(i.value),e=Number(b.value),t=Object.fromEntries((c.items||[]).map(u=>[u.eleveId,u])),d=j.user?.teacherId??j.user?.id??null,U=x.value.map(async u=>{const y=r.value[u.id];if(!y)return;const A=t[u.id];A?A.statut!==y&&await c.updateOne(A.id,{statut:y}):await c.createOne({date:v.value,classeId:l,coursId:e,eleveId:u.id,statut:y,teacherId:d})});await Promise.all(U),await c.fetch({date:v.value,classeId:l,coursId:e});const M={};(c.items||[]).forEach(u=>{M[u.eleveId]=u.statut}),r.value=M,alert("Présences enregistrées ✔")}catch(l){console.error(l),alert("Erreur lors de l’enregistrement")}finally{h.value=!1}}}return(l,e)=>(o(),a("div",Z,[s("div",ee,[e[7]||(e[7]=s("div",null,[s("h1",{class:"text-xl font-semibold"},"Marquer les présences"),s("p",{class:"text-sm text-slate-500 dark:text-slate-400"}," Sélectionne une date, une classe, un cours — puis marque Présent / Absent / Retard. ")],-1)),s("div",te,[s("button",{type:"button",class:"btn",onClick:e[0]||(e[0]=t=>P("P")),disabled:!p.value},"Tout P",8,se),s("button",{type:"button",class:"btn",onClick:e[1]||(e[1]=t=>P("A")),disabled:!p.value},"Tout A",8,le),s("button",{type:"button",class:"btn",onClick:e[2]||(e[2]=t=>P("R")),disabled:!p.value},"Tout R",8,ae),s("button",{type:"button",class:"btn-primary",onClick:R,disabled:!p.value||h.value},[e[6]||(e[6]=s("svg",{class:"h-4 w-4",viewBox:"0 0 24 24",fill:"currentColor"},[s("path",{d:"M5 13l4 4L19 7"})],-1)),h.value?(o(),a("span",ie,"Enregistrement…")):(o(),a("span",ne,"Enregistrer"))],8,oe)])]),s("div",re,[$(s("input",{"onUpdate:modelValue":e[3]||(e[3]=t=>v.value=t),type:"date",class:"input"},null,512),[[G,v.value]]),$(s("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>i.value=t),class:"input"},[e[8]||(e[8]=s("option",{value:""},"— Classe —",-1)),(o(!0),a(g,null,C(V.value,t=>(o(),a("option",{key:t.id,value:String(t.id)},n(t.libelle||t.label||t.code),9,de))),128))],512),[[O,i.value]]),$(s("select",{"onUpdate:modelValue":e[5]||(e[5]=t=>b.value=t),class:"input"},[e[9]||(e[9]=s("option",{value:""},"— Cours —",-1)),(o(!0),a(g,null,C(T.value,t=>(o(),a("option",{key:t.id,value:String(t.id)},n(t.matiere)+" — "+n(t.intitule||t.code),9,ue))),128))],512),[[O,b.value]])]),i.value?b.value?(o(),a("div",be,[s("div",me,[s("span",pe,n(x.value.length)+" élèves — "+n(q.value)+" — "+n(D.value),1),K(c).loading?(o(),a("span",_e,"Chargement…")):H("",!0)]),s("div",fe,[(o(!0),a(g,null,C(x.value,t=>(o(),a("div",{key:t.id,class:"flex items-center justify-between p-3"},[s("div",he,[s("div",xe,n(t.nom),1),s("div",ke,n(t.matricule),1)]),s("div",ye,[s("button",{type:"button",class:f(N(t.id,"P")),onClick:d=>_(t.id,"P")},"P",10,ge),s("button",{type:"button",class:f(N(t.id,"A")),onClick:d=>_(t.id,"A")},"A",10,Ce),s("button",{type:"button",class:f(N(t.id,"R")),onClick:d=>_(t.id,"R")},"R",10,we)])]))),128))]),s("div",Ie,[s("table",Ne,[e[10]||(e[10]=s("thead",{class:"bg-slate-50 text-slate-600 dark:bg-slate-800 dark:text-slate-300"},[s("tr",null,[s("th",{class:"px-4 py-3 font-medium"},"Élève"),s("th",{class:"px-4 py-3 font-medium"},"Matricule"),s("th",{class:"px-4 py-3 font-medium w-56"},"Statut")])],-1)),s("tbody",null,[(o(!0),a(g,null,C(x.value,t=>(o(),a("tr",{key:t.id,class:"border-t border-slate-100 dark:border-slate-800"},[s("td",Se,n(t.nom),1),s("td",Pe,n(t.matricule),1),s("td",Ae,[s("div",$e,[s("button",{type:"button",class:f(S(t.id,"P")),onClick:d=>_(t.id,"P")},"Présent",10,je),s("button",{type:"button",class:f(S(t.id,"A")),onClick:d=>_(t.id,"A")},"Absent",10,Ee),s("button",{type:"button",class:f(S(t.id,"R")),onClick:d=>_(t.id,"R")},"Retard",10,Re)])])]))),128))])])]),s("div",Me,[s("span",Oe," Non enregistrée(s) : "+n(F.value),1),s("button",{type:"button",class:"btn-primary",onClick:R,disabled:!p.value||h.value}," Enregistrer ",8,Be)])])):(o(),a("div",ve,"Choisis un cours pour cette classe.")):(o(),a("div",ce,"Choisis une classe pour commencer."))]))}};export{Le as default};
