import{m as E,p as D,c as u,a as r,b as s,x as P,j as I,O as N,F as S,h as M,t as d,o as n}from"./index-BVVU7ImF.js";import{u as q}from"./useEvaluations-2EkqKUXk.js";import{u as J}from"./useClasses-6cjNtIyF.js";import{u as z}from"./useCours-WlUt9X8U.js";import{u as H}from"./usePeriodes-DPgYpSBx.js";import{u as K}from"./useStudents-D51OTvSI.js";const Q={class:"space-y-6"},X={class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},Y={class:"flex flex-wrap gap-2"},Z=["disabled"],ee={class:"grid gap-3 md:grid-cols-4"},te=["disabled"],se=["value"],ae=["value"],le=["disabled"],oe=["value"],re={key:0,class:"rounded-xl border border-slate-200 p-4 text-sm dark:border-slate-800"},de={key:1,class:"rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-300"},ne={key:2,class:"rounded-xl border border-slate-200 p-4 text-sm text-slate-500 dark:border-slate-800 dark:text-slate-400"},ie={key:3,class:"grid gap-3 sm:grid-cols-3"},ue={class:"rounded-xl border border-slate-200 p-4 dark:border-slate-800"},me={class:"mt-1 text-2xl font-semibold"},ce={class:"rounded-xl border border-slate-200 p-4 dark:border-slate-800"},be={class:"mt-1 text-2xl font-semibold"},ve={class:"rounded-xl border border-slate-200 p-4 dark:border-slate-800"},pe={class:"mt-1 text-2xl font-semibold"},xe={key:4,class:"overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-slate-800 dark:bg-slate-900"},fe={class:"flex items-center justify-between border-b border-slate-100 px-4 py-3 text-sm dark:border-slate-800"},ge={class:"text-slate-600 dark:text-slate-300"},ke={class:"text-slate-500 dark:text-slate-400"},ye={class:"overflow-x-auto"},he={class:"min-w-full text-left text-sm"},_e={class:"bg-slate-50 text-slate-600 dark:bg-slate-800 dark:text-slate-300"},we={class:"px-4 py-3 font-medium sticky left-0 bg-slate-50 dark:bg-slate-800"},Ee={class:"px-4 py-3 font-medium sticky left-0 bg-white dark:bg-slate-900"},Ie={class:"px-4 py-3"},Ne={class:"px-4 py-3"},Se={class:"px-4 py-3"},Te={__name:"AcadRapports",setup(Me){const g=q(),k=J(),y=z(),h=H(),_=K(),c=E("classe"),p=E(""),x=E(""),f=E("");D(async()=>{await Promise.all([k.fetch(),y.fetch(),h.fetch(),_.fetch(),g.fetch()])});const w=u(()=>k.items||[]),W=u(()=>h.items||[]),U=u(()=>Object.fromEntries((y.items||[]).map(a=>[a.id,a]))),A=u(()=>Object.fromEntries((_.items||[]).map(a=>[a.id,a]))),C=u(()=>{const a=new Set;return(y.items||[]).forEach(e=>e.matiere&&a.add(e.matiere)),(g.items||[]).forEach(e=>e.matiere&&a.add(e.matiere)),Array.from(a).sort()}),B=u(()=>(g.items||[]).map(a=>{const e=a.coursId?U.value[a.coursId]:null,t=A.value[a.eleveId];return{...a,classeId:t?.classeId??e?.classeId??null,matiere:a.matiere||e?.matiere||""}})),V=u(()=>B.value.filter(a=>!(p.value&&Number(a.classeId)!==Number(p.value)||x.value&&Number(a.periodeId)!==Number(x.value)||f.value&&a.matiere!==f.value)));function j(a,e,t){const b=new Map;a.forEach(l=>{const i=e(l);if(!i)return;const v=b.get(i)||{key:i,label:t(l),sumW:0,sumWN:0,nbEval:0,pass:0},T=Number(l.coef||1),$=Number(l.note||0);v.sumW+=T,v.sumWN+=T*$,v.nbEval++,$>=10&&v.pass++,b.set(i,v)});const o=Array.from(b.values()).map(l=>({...l,moyenne:l.sumW?l.sumWN/l.sumW:0,tauxReussite:l.nbEval?l.pass/l.nbEval:0}));return o.sort((l,i)=>i.moyenne-l.moyenne),o}const m=u(()=>c.value==="classe"?j(V.value,a=>a.classeId,a=>{const e=k.byId?.[a.classeId]||w.find(t=>t.id===a.classeId);return e?e.libelle||e.label||e.code:`Classe #${a.classeId??"—"}`}):j(V.value,a=>a.matiere||"(Sans matière)",a=>a.matiere||"(Sans matière)")),R=u(()=>{const a=m.value.reduce((o,l)=>o+l.sumW,0),e=m.value.reduce((o,l)=>o+l.sumWN,0),t=m.value.reduce((o,l)=>o+l.nbEval,0),b=m.value.reduce((o,l)=>o+Math.round(l.tauxReussite*l.nbEval),0);return{moyenneGlobale:a?e/a:0,nbEval:t,tauxReussite:t?b/t:0}}),L=u(()=>k.loading||y.loading||h.loading||_.loading||g.loading),F=u(()=>k.error?.message||y.error?.message||h.error?.message||_.error?.message||g.error?.message||null),O=u(()=>{const a=x.value?W.find(t=>t.id===Number(x.value))?.label||"":"Toutes périodes";if(c.value==="classe")return`Moyennes par classe — ${a}${f.value?" — Matière: "+f.value:""}`;const e=p.value?w.find(t=>t.id===Number(p.value))?.libelle||"":"Toutes classes";return`Moyennes par matière — ${a} — ${e}`});function G(){const a=["Groupe","Moyenne","Evals","Taux>=10"],e=m.value.map(i=>[i.label,i.moyenne.toFixed(2),String(i.nbEval),(i.tauxReussite*100).toFixed(0)+"%"]),t=[a,...e].map(i=>i.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join(`
`),b=new Blob([t],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a");o.href=URL.createObjectURL(b);const l=c.value==="classe"?"par-classe":"par-matiere";o.download=`rapports-acad-${l}.csv`,o.click(),URL.revokeObjectURL(o.href)}return(a,e)=>(n(),r("div",Q,[s("div",X,[e[6]||(e[6]=s("div",null,[s("h1",{class:"text-xl font-semibold"},"Rapports académiques"),s("p",{class:"text-sm text-slate-500 dark:text-slate-400"}," Moyennes pondérées par classe / matière et période. ")],-1)),s("div",Y,[s("button",{type:"button",class:"rounded-md border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900",onClick:e[0]||(e[0]=t=>a.window.print())}," Imprimer "),s("button",{type:"button",class:"rounded-md border border-violet-200 bg-violet-600 px-3 py-2 text-sm font-medium text-white hover:bg-violet-700 dark:border-violet-900",onClick:e[1]||(e[1]=t=>G()),disabled:m.value.length===0}," Export CSV ",8,Z)])]),s("div",ee,[I(s("select",{"onUpdate:modelValue":e[2]||(e[2]=t=>c.value=t),class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[...e[7]||(e[7]=[s("option",{value:"classe"},"Vue par classe",-1),s("option",{value:"matiere"},"Vue par matière",-1)])],512),[[N,c.value]]),I(s("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>p.value=t),class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100",disabled:c.value==="classe"&&!w.value.length},[e[8]||(e[8]=s("option",{value:""},"— Toutes classes —",-1)),(n(!0),r(S,null,M(w.value,t=>(n(),r("option",{key:t.id,value:t.id},d(t.libelle||t.label||t.code),9,se))),128))],8,te),[[N,p.value,void 0,{number:!0}]]),I(s("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>x.value=t),class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[e[9]||(e[9]=s("option",{value:""},"— Toutes périodes —",-1)),(n(!0),r(S,null,M(W.value,t=>(n(),r("option",{key:t.id,value:t.id},d(t.label),9,ae))),128))],512),[[N,x.value,void 0,{number:!0}]]),I(s("select",{"onUpdate:modelValue":e[5]||(e[5]=t=>f.value=t),class:"w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100",disabled:c.value==="classe"&&!C.value.length},[e[10]||(e[10]=s("option",{value:""},"— Toutes matières —",-1)),(n(!0),r(S,null,M(C.value,t=>(n(),r("option",{key:t,value:t},d(t),9,oe))),128))],8,le),[[N,f.value]])]),L.value?(n(),r("div",re," Chargement… ")):F.value?(n(),r("div",de,d(F.value),1)):m.value.length===0?(n(),r("div",ne," Aucun résultat pour ces filtres. ")):(n(),r("div",ie,[s("div",ue,[e[11]||(e[11]=s("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Moyenne globale",-1)),s("div",me,d(R.value.moyenneGlobale.toFixed(2))+"/20",1)]),s("div",ce,[e[12]||(e[12]=s("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Évaluations prises en compte",-1)),s("div",be,d(R.value.nbEval),1)]),s("div",ve,[e[13]||(e[13]=s("div",{class:"text-xs text-slate-500 dark:text-slate-400"},"Taux de réussite (≥10)",-1)),s("div",pe,d((R.value.tauxReussite*100).toFixed(0))+"%",1)])])),m.value.length?(n(),r("div",xe,[s("div",fe,[s("span",ge,d(O.value),1),s("span",ke,d(m.value.length)+" ligne(s) ",1)]),s("div",ye,[s("table",he,[s("thead",_e,[s("tr",null,[s("th",we,d(c.value==="classe"?"Classe":"Matière"),1),e[14]||(e[14]=s("th",{class:"px-4 py-3 font-medium"},"Moyenne",-1)),e[15]||(e[15]=s("th",{class:"px-4 py-3 font-medium"},"Évals",-1)),e[16]||(e[16]=s("th",{class:"px-4 py-3 font-medium"},"Taux ≥10",-1))])]),s("tbody",null,[(n(!0),r(S,null,M(m.value,t=>(n(),r("tr",{key:t.key,class:"border-t border-slate-100 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800/60"},[s("td",Ee,d(t.label),1),s("td",Ie,d(t.moyenne.toFixed(2)),1),s("td",Ne,d(t.nbEval),1),s("td",Se,d((t.tauxReussite*100).toFixed(0))+"%",1)]))),128))])])])])):P("",!0)]))}};export{Te as default};
